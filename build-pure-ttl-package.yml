name: Build Pure TTL Package

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 50

    steps:
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: 2. ä¸‹è½½åŸå§‹ TTL åˆ·æœºåŒ…
      run: |
        echo "ä¸‹è½½æµ·çº³æ€å®˜æ–¹ TTL åˆ·æœºåŒ…..."
        wget --no-check-certificate -c "https://node4.histb.com:9088/update/system/TTL-hi3798mv100-32bit.zip" -O original_ttl.zip
        echo "åŸå§‹åˆ·æœºåŒ…ä¿¡æ¯:"
        ls -lh original_ttl.zip
        echo "åˆ†æåŒ…å†…å®¹..."
        unzip -l original_ttl.zip | head -20

    - name: 3. è§£å‹åŸå§‹åŒ…å¹¶å¤‡ä»½
      run: |
        # è§£å‹åˆ°ç‹¬ç«‹ç›®å½•ï¼Œä½œä¸ºæˆ‘ä»¬çš„â€œæ¨¡æ¿â€
        mkdir -p ttl_template
        unzip -q original_ttl.zip -d ttl_template/
        
        # é‡ç‚¹ï¼šå¤‡ä»½åŸå§‹rootfsï¼Œç”¨äºè·å–å…¶ç²¾ç¡®å¤§å°
        if [ -f "ttl_template/rootfs-32.img" ]; then
          cp ttl_template/rootfs-32.img original_rootfs_backup.img
          ORIG_SIZE=$(stat -c%s "ttl_template/rootfs-32.img")
          echo "âœ… åŸå§‹ rootfs-32.img å¤§å°: $ORIG_SIZE å­—èŠ‚ (çº¦ $((ORIG_SIZE/1024/1024))MB)"
          echo "å·²å¤‡ä»½ä¸º original_rootfs_backup.img"
        else
          echo "âŒ é”™è¯¯ï¼šåœ¨TTLåŒ…ä¸­æœªæ‰¾åˆ° rootfs-32.img"
          exit 1
        fi
        
        echo "åŸå§‹TTLåŒ…è§£å‹å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨:"
        find ttl_template -type f | sort

    - name: 4. å®‰è£…æ„å»ºä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-user-static \
          rsync \
          gzip \
          e2fsprogs \
          zip \
          unzip \
          parted

    - name: 5. æ„å»ºçº¯å‡€ Ubuntu æ ¹æ–‡ä»¶ç³»ç»Ÿ (åŸºäºå®˜æ–¹Base)
      run: |
        set -e
        echo "=== å¼€å§‹ä»é›¶æ„å»ºçº¯å‡€ Ubuntu ç³»ç»Ÿ ==="
        
        # 5.1 åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        ROOTFS_DIR=$(pwd)/pure_rootfs_build
        sudo rm -rf $ROOTFS_DIR
        mkdir -p $ROOTFS_DIR
        
        # 5.2 ä¸‹è½½å¹¶è§£å‹æœ€å¹²å‡€çš„ Ubuntu Base 20.04
        echo "ä¸‹è½½å®˜æ–¹ ubuntu-base..."
        wget -c https://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.5-base-armhf.tar.gz
        sudo tar -xpf ubuntu-base-20.04.5-base-armhf.tar.gz -C $ROOTFS_DIR
        
        # 5.3 å‡†å¤‡ chroot ç¯å¢ƒ
        echo "å‡†å¤‡ Chroot ç¯å¢ƒ..."
        sudo cp /usr/bin/qemu-arm-static $ROOTFS_DIR/usr/bin/
        sudo cp -L /etc/resolv.conf $ROOTFS_DIR/etc/
        
        # æŒ‚è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        sudo mount -t proc /proc $ROOTFS_DIR/proc
        sudo mount -t sysfs /sys $ROOTFS_DIR/sys
        sudo mount -o bind /dev $ROOTFS_DIR/dev
        sudo mount -o bind /dev/pts $ROOTFS_DIR/dev/pts

        # 5.4 åœ¨ Chroot ä¸­é…ç½®çº¯å‡€ç³»ç»Ÿ
        echo "æ­£åœ¨ Chroot ç¯å¢ƒä¸­å®‰è£…å’Œé…ç½®ç³»ç»Ÿ..."
        sudo chroot $ROOTFS_DIR /bin/bash << 'CHROOT_EOF'
        #!/bin/bash
        set -e
        export DEBIAN_FRONTEND=noninteractive
        export LC_ALL=C
        
        echo "----- ç¬¬1æ­¥: é…ç½®ç¯å¢ƒä¸è½¯ä»¶æº -----"
        # å…³é”®ä¿®å¤ï¼šæŒ‚è½½tmpfsè§£å†³ç©ºé—´ä¸è¶³
        mount -t tmpfs tmpfs /tmp
        mount -t tmpfs tmpfs /var/cache/apt/archives
        
        # ä½¿ç”¨åä¸ºäº‘é•œåƒæºï¼ˆå›½å†…ç¨³å®šï¼‰
        cat > /etc/apt/sources.list << 'SOURCES_EOF'
deb http://repo.huaweicloud.com/ubuntu-ports/ focal main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-updates main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-security main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-backports main restricted universe multiverse
SOURCES_EOF
        
        echo "----- ç¬¬2æ­¥: æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…æ ¸å¿ƒè½¯ä»¶ -----"
        apt-get update
        
        # åˆ†é˜¶æ®µå®‰è£…ï¼Œç¡®ä¿åŸºç¡€ä¼˜å…ˆ
        apt-get install -y systemd systemd-sysv dbus
        apt-get install -y ifupdown net-tools iproute2 iputils-ping
        apt-get install -y openssh-server ssh sudo
        apt-get install -y vim-tiny less lsof htop wget curl
        apt-get install -y cron rsyslog logrotate bash-completion
        apt-get install -y network-manager ethtool
        
        echo "----- ç¬¬3æ­¥: åŸºç¡€ç³»ç»Ÿé…ç½® -----"
        # ä¸»æœºåä¸ç½‘ç»œ
        echo "hi3798mv100" > /etc/hostname
        cat > /etc/hosts << 'HOSTS_EOF'
127.0.0.1   localhost
127.0.1.1   hi3798mv100
::1         ip6-localhost ip6-loopback
fe00::0     ip6-localnet
ff00::0     ip6-mcastprefix
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
HOSTS_EOF
        
        # æ—¶åŒº
        ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        
        # Root å¯†ç 
        echo "root:root123" | chpasswd
        
        # SSH é…ç½®ï¼ˆå…è®¸Rootç™»å½•ï¼‰
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        
        # ç½‘ç»œé…ç½® (DHCP)
        mkdir -p /etc/network/interfaces.d
        cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
auto eth0
iface eth0 inet dhcp
NET_EOF
        
        echo "----- ç¬¬4æ­¥: æ·±åº¦æ¸…ç† -----"
        apt-get autoremove -y --purge
        apt-get clean
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
        
        # ç§»é™¤æ„å»ºç”¨çš„æ¨¡æ‹Ÿå™¨
        rm -f /usr/bin/qemu-arm-static
        
        echo "----- âœ… çº¯å‡€ Ubuntu ç³»ç»Ÿé…ç½®å®Œæˆ -----"
        CHROOT_EOF

        # 5.5 å¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        sudo umount -lf $ROOTFS_DIR/dev/pts 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/dev 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/sys 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/proc 2>/dev/null || true
        
        echo "=== çº¯å‡€æ ¹æ–‡ä»¶ç³»ç»Ÿæ„å»ºå®Œæˆ ==="

    - name: 6. åˆ›å»ºä¸åŸå§‹å¤§å°ä¸€è‡´çš„çº¯å‡€é•œåƒ
      run: |
        echo "=== åˆ›å»ºå¯ç›´æ¥æ›¿æ¢çš„ rootfs-32.img ==="
        
        # ä½¿ç”¨åŸå§‹é•œåƒçš„ç²¾ç¡®å¤§å°æ¥åˆ›å»ºæ–°é•œåƒ
        ORIG_SIZE=$(stat -c%s "original_rootfs_backup.img")
        echo "ç›®æ ‡é•œåƒå¤§å°: $ORIG_SIZE å­—èŠ‚"
        
        # åˆ›å»ºç©ºç™½æ–‡ä»¶
        PURE_ROOTFS_IMG="rootfs-32-pure.img"
        dd if=/dev/zero of="$PURE_ROOTFS_IMG" bs=1 count=0 seek=$ORIG_SIZE status=progress
        
        # æ ¼å¼åŒ–ä¸º ext4
        mkfs.ext4 -F -L "rootfs" "$PURE_ROOTFS_IMG"
        
        # æŒ‚è½½å¹¶å¤åˆ¶æˆ‘ä»¬æ„å»ºçš„çº¯å‡€ç³»ç»Ÿ
        TEMP_MOUNT=$(pwd)/final_mount
        mkdir -p $TEMP_MOUNT
        sudo mount -o loop "$PURE_ROOTFS_IMG" $TEMP_MOUNT
        sudo cp -a pure_rootfs_build/* $TEMP_MOUNT/
        sync
        sudo umount $TEMP_MOUNT
        
        # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§
        e2fsck -p -f "$PURE_ROOTFS_IMG" || true
        
        echo "âœ… çº¯å‡€é•œåƒåˆ›å»ºæˆåŠŸ:"
        ls -lh "$PURE_ROOTFS_IMG"

    - name: 7. æ›¿æ¢å¹¶é‡æ–°æ‰“åŒ…ä¸ºå®Œæ•´TTLåˆ·æœºåŒ…
      run: |
        echo "=== é‡æ–°æ‰“åŒ…ä¸ºå®Œæ•´ TTL åˆ·æœºåŒ… ==="
        
        # 7.1 å‡†å¤‡æœ€ç»ˆæ‰“åŒ…ç›®å½•
        FINAL_PACKAGE_DIR=$(pwd)/TTL-hi3798mv100-32bit-PURE
        rm -rf $FINAL_PACKAGE_DIR
        mkdir -p $FINAL_PACKAGE_DIR
        
        # 7.2 å¤åˆ¶åŸå§‹TTLåŒ…çš„æ‰€æœ‰æ–‡ä»¶
        echo "å¤åˆ¶åŸå§‹TTLåŒ…ç»“æ„..."
        cp -r ttl_template/* $FINAL_PACKAGE_DIR/
        
        # 7.3 ç”¨çº¯å‡€é•œåƒæ›¿æ¢åŸ rootfs-32.img
        echo "æ›¿æ¢æ ¸å¿ƒç³»ç»Ÿé•œåƒ..."
        rm -f "$FINAL_PACKAGE_DIR/rootfs-32.img"
        cp rootfs-32-pure.img "$FINAL_PACKAGE_DIR/rootfs-32.img"
        
        # 7.4 æ·»åŠ ç‰ˆæœ¬æ ‡è¯†æ–‡ä»¶
        cat > "$FINAL_PACKAGE_DIR/æœ¬åŒ…è¯´æ˜.txt" << 'EOF'
        ========================================
        æµ·æ€ Hi3798mv100 çº¯å‡€ Ubuntu TTL åˆ·æœºåŒ…
        ========================================
        
        ğŸ“¢ é‡è¦è¯´æ˜
        æœ¬åˆ·æœºåŒ…åŸºäºå®˜æ–¹æµ·çº³æ€ TTL åŒ…åˆ¶ä½œï¼Œä½†æ ¸å¿ƒç³»ç»Ÿå·²æ›¿æ¢ä¸ºçº¯å‡€çš„ Ubuntu 20.04.5 Baseã€‚
        
        ğŸ”„ ä¸»è¦å˜æ›´
        1. åŸå‚ rootfs-32.img å·²è¢«æ›¿æ¢ä¸ºçº¯å‡€ Ubuntu ç³»ç»Ÿ
        2. ç³»ç»Ÿé™¤åŸºç¡€ç»„ä»¶å¤–ï¼Œæ— ä»»ä½•é¢„è£…ç¬¬ä¸‰æ–¹è½¯ä»¶
        3. å·²é…ç½®å›½å†…è½¯ä»¶æºï¼Œæ›´æ–°å®‰è£…æ›´å¿«é€Ÿ
        
        ğŸ›  ç³»ç»Ÿä¿¡æ¯
        - ç³»ç»Ÿç‰ˆæœ¬: Ubuntu 20.04.5 LTS (Focal Fossa) Base
        - ä¸»æœºåç§°: hi3798mv100
        - Root å¯†ç : root123
        - é»˜è®¤æ—¶åŒº: Asia/Shanghai
        - è½¯ä»¶æº: åä¸ºäº‘é•œåƒ
        
        ğŸ“¶ ç½‘ç»œé…ç½®
        - é»˜è®¤å¯ç”¨ DHCP è‡ªåŠ¨è·å–IP
        - SSH æœåŠ¡å·²å¼€å¯ (å…è®¸rootç™»å½•)
        
        âš¡ é¦–æ¬¡å¯åŠ¨åå¿…é¡»æ‰§è¡Œ
        # æ‰©å±•æ ¹åˆ†åŒºä»¥ä½¿ç”¨å…¨éƒ¨å­˜å‚¨ç©ºé—´
        resize2fs /dev/mmcblk0p9
        
        ğŸ—“ æ„å»ºæ—¥æœŸ: $(date)
        EOF
        
        echo "æœ€ç»ˆåˆ·æœºåŒ…å†…å®¹:"
        ls -la $FINAL_PACKAGE_DIR/
        
        # 7.5 æ‰“åŒ…æˆZIPæ–‡ä»¶ï¼ˆä¸åŸå§‹åŒ…åŒåï¼Œä½†å†…å®¹å·²æ›¿æ¢ï¼‰
        cd $FINAL_PACKAGE_DIR
        zip -r ../TTL-hi3798mv100-32bit-PURE-$(date +%Y%m%d).zip .
        cd ..
        
        echo "âœ… æ‰“åŒ…å®Œæˆ! ç”Ÿæˆæ–‡ä»¶:"
        ls -lh TTL-hi3798mv100-32bit-PURE-*.zip

    - name: 8. ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: pure-ttl-package
        path: |
          TTL-hi3798mv100-32bit-PURE-*.zip
          rootfs-32-pure.img
        retention-days: 7

    - name: 9. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (å¯é€‰)
      if: always()
      run: |
        echo "æ¸…ç†æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶..."
        sudo rm -rf pure_rootfs_build final_mount ttl_template 2>/dev/null || true
        rm -f original_ttl.zip original_rootfs_backup.img ubuntu-base-20.04.5-base-armhf.tar.gz 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆï¼Œæœ€ç»ˆäº§ç‰©å·²ä¿ç•™ã€‚"
