name: Build Hi3798 RootFS from Release Base Image

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ main ] # 主分支推送时触发（可选）

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        submodules: recursive # 如果有子模块

    - name: 下载基础镜像
      run: |
        # 从您指定的 Releases 链接下载已修复的基础镜像
        wget -O base_rootfs.img https://github.com/hongli11/hi3798mv100-ubuntu-builder/releases/download/v1.0/rootfs-32-fixed.img
        echo "下载完成。镜像信息："
        ls -lh base_rootfs.img

    - name: 安装构建依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static rsync gzip \
                               kpartx dosfstools fdisk

    - name: 挂载镜像并准备系统
      run: |
        # 1. 设置镜像为可读写并挂载
        sudo mkdir -p /mnt/rootfs
        # 使用 kpartx 挂载可能包含多个分区的镜像
        sudo kpartx -av base_rootfs.img
        # 假设根文件系统在第一个分区 (loop0p1)，请根据实际情况调整
        LOOP_DEV=$(sudo losetup --list | grep base_rootfs.img | awk '{print $1}')
        sudo mount ${LOOP_DEV}p1 /mnt/rootfs

        # 2. 准备 chroot 环境
        sudo cp /usr/bin/qemu-arm-static /mnt/rootfs/usr/bin/
        sudo cp /etc/resolv.conf /mnt/rootfs/etc/resolv.conf
        sudo mount -t proc /proc /mnt/rootfs/proc
        sudo mount -t sysfs /sys /mnt/rootfs/sys
        sudo mount -o bind /dev /mnt/rootfs/dev
        sudo mount -o bind /dev/pts /mnt/rootfs/dev/pts

    - name: 在 Chroot 环境中定制系统
      run: |
        # 使用 heredoc 在 chroot 环境中执行一系列命令
        sudo chroot /mnt/rootfs /bin/bash << 'CHROOT_EOF'
        # 设置环境变量，避免安装过程中的交互提示
        export DEBIAN_FRONTEND=noninteractive
        export LC_ALL=C

        echo "开始配置系统..."

        # 1. 更新软件源并升级系统 (使用国内源加速)
        cat > /etc/apt/sources.list << 'APT_SOURCES'
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse
        APT_SOURCES

        apt-get update
        apt-get upgrade -y

        # 2. 安装核心和常用软件包
        apt-get install -y --no-install-recommends \
          systemd-sysv sudo ssh net-tools iputils-ping \
          wget curl vim-tiny htop less lsof \
          network-manager ethtool ifupdown \
          rsyslog cron bash-completion

        # 3. 基础系统配置
        # 设置主机名
        echo "hi3798mv100" > /etc/hostname
        echo -e "127.0.0.1\tlocalhost\n127.0.1.1\thi3798mv100" > /etc/hosts

        # 设置 root 密码（刷机后请务必修改！）
        echo "root:root123" | chpasswd
        # 允许 Root SSH 登录（仅限首次调试，建议后期关闭）
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

        # 4. 网络配置示例（DHCP）
        cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
        auto eth0
        iface eth0 inet dhcp
        # 如需静态IP，注释掉上一行，取消注释并修改以下行
        # iface eth0 inet static
        # address 192.168.1.100
        # netmask 255.255.255.0
        # gateway 192.168.1.1
        # dns-nameservers 8.8.8.8
        NET_EOF

        # 5. 清理以减小镜像体积
        apt-get autoremove -y
        apt-get clean
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

        echo "系统配置完成！"
        CHROOT_EOF

    - name: 完成并打包镜像
      run: |
        # 1. 卸载 chroot 环境
        sudo umount -lf /mnt/rootfs/dev/pts
        sudo umount -lf /mnt/rootfs/dev
        sudo umount -lf /mnt/rootfs/sys
        sudo umount -lf /mnt/rootfs/proc

        # 2. 卸载根分区并清理 loop 设备
        sudo umount /mnt/rootfs
        LOOP_DEV=$(sudo losetup --list | grep base_rootfs.img | awk '{print $1}')
        sudo kpartx -d $LOOP_DEV
        sudo losetup -d $LOOP_DEV

        # 3. 重命名并压缩最终镜像
        cp base_rootfs.img hi3798mv100-ubuntu-custom-$(date +%Y%m%d).img
        gzip -9 hi3798mv100-ubuntu-custom-*.img

        echo "生成的文件："
        ls -lh *.gz

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: custom-rootfs-images
        path: |
          hi3798mv100-ubuntu-custom-*.gz
        retention-days: 7
