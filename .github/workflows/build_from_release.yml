name: Build Hi3798 RootFS from Release Base Image

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4

    - name: 下载基础镜像
      run: |
        # 从 Releases 下载已修复的基础镜像
        wget -O base_rootfs.img https://github.com/hongli11/hi3798mv100-ubuntu-builder/releases/download/v1.0/rootfs-32-fixed.img
        echo "下载完成。基础镜像信息："
        ls -lh base_rootfs.img
        file base_rootfs.img || true

    - name: 安装构建依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static rsync gzip file

    - name: 挂载镜像并准备系统 (智能通用方法)
      run: |
        # 1. 创建挂载点
        sudo mkdir -p /mnt/rootfs
        
        # 2. 创建回环设备（-P 参数尝试扫描分区，兼容有分区表的镜像）
        LOOP_DEV=$(sudo losetup --show -f -P base_rootfs.img)
        echo "创建的回环设备: $LOOP_DEV"
        
        # 3. 智能挂载：先尝试挂载第一个分区，若失败则挂载整个设备
        if [ -b "${LOOP_DEV}p1" ]; then
          echo "检测到分区 ${LOOP_DEV}p1，尝试挂载..."
          sudo mount ${LOOP_DEV}p1 /mnt/rootfs && echo "成功挂载为分区镜像。"
        else
          echo "未检测到标准分区，尝试将整个设备作为文件系统挂载..."
          sudo mount $LOOP_DEV /mnt/rootfs && echo "成功挂载为直接文件系统镜像。"
        fi
        
        # 4. 准备 chroot 环境
        sudo cp /usr/bin/qemu-arm-static /mnt/rootfs/usr/bin/
        [[ -f /etc/resolv.conf ]] && sudo cp /etc/resolv.conf /mnt/rootfs/etc/
        sudo mount -t proc /proc /mnt/rootfs/proc
        sudo mount -t sysfs /sys /mnt/rootfs/sys
        sudo mount -o bind /dev /mnt/rootfs/dev
        sudo mount -o bind /dev/pts /mnt/rootfs/dev/pts

    - name: 在 Chroot 环境中定制系统
      run: |
        # 使用 heredoc 在 chroot 环境中执行命令
        sudo chroot /mnt/rootfs /bin/bash << 'CHROOT_EOF'
        # 设置环境
        export DEBIAN_FRONTEND=noninteractive
        export LC_ALL=C
        echo "开始在 chroot 环境中配置系统..."

        # 1. 配置软件源并更新
        cat > /etc/apt/sources.list << 'APT_SOURCES'
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse
        deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse
        APT_SOURCES

        apt-get update
        apt-get upgrade -y

        # 2. 安装核心软件包
        apt-get install -y --no-install-recommends \
          systemd-sysv sudo ssh net-tools iputils-ping \
          wget curl vim-tiny htop less lsof \
          network-manager ethtool ifupdown \
          rsyslog cron bash-completion

        # 3. 基础系统配置
        echo "hi3798mv100" > /etc/hostname
        echo -e "127.0.0.1\tlocalhost\n127.0.1.1\thi3798mv100" > /etc/hosts
        echo "root:root123" | chpasswd
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

        # 4. 网络配置 (DHCP)
        mkdir -p /etc/network/interfaces.d
        cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
        auto eth0
        iface eth0 inet dhcp
        NET_EOF

        # 5. 清理系统
        apt-get autoremove -y
        apt-get clean
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
        echo "系统配置完成！"
        CHROOT_EOF

    - name: 完成并打包镜像
      run: |
        # 1. 卸载 chroot 虚拟文件系统
        sudo umount -lf /mnt/rootfs/dev/pts 2>/dev/null || true
        sudo umount -lf /mnt/rootfs/dev 2>/dev/null || true
        sudo umount -lf /mnt/rootfs/sys 2>/dev/null || true
        sudo umount -lf /mnt/rootfs/proc 2>/dev/null || true
        
        # 2. 卸载根文件系统并清理回环设备
        sudo umount /mnt/rootfs
        LOOP_DEV=$(sudo losetup -j base_rootfs.img | head -1 | cut -d: -f1)
        if [ -n "$LOOP_DEV" ]; then
          sudo losetup -d $LOOP_DEV
          echo "已清理回环设备: $LOOP_DEV"
        fi
        
        # 3. 重命名并压缩最终镜像
        FINAL_IMG_NAME="hi3798mv100-ubuntu-custom-$(date +%Y%m%d).img"
        cp base_rootfs.img "$FINAL_IMG_NAME"
        gzip -9 "$FINAL_IMG_NAME"
        
        echo "构建成功！生成的文件："
        ls -lh *.gz

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: custom-rootfs-image
        path: |
          hi3798mv100-ubuntu-custom-*.img.gz
        # 修正位置：retention-days 应在此处，与 name/path 对齐
        retention-days: 7

    - name: 上传镜像到 WebDAV
      if: success() # 仅在之前所有步骤成功时执行
      env:
        WEBDAV_URL: ${{ secrets.WEBDAV_URL }}       # 例如：https://dav.jianguoyun.com/dav/你的目录/
        WEBDAV_USER: ${{ secrets.WEBDAV_USERNAME }}
        WEBDAV_PASS: ${{ secrets.WEBDAV_PASSWORD }}
      run: |
        # 找到最新生成的镜像文件
        IMAGE_FILE=$(ls -t hi3798mv100-ubuntu-custom-*.img.gz | head -1)
        echo "准备上传文件：$IMAGE_FILE"

        # 使用 curl 命令上传到 WebDAV
        curl -f --connect-timeout 30 --retry 3 --retry-delay 5 \
          -u "$WEBDAV_USER:$WEBDAV_PASS" \
          -T "$IMAGE_FILE" \
          "${WEBDAV_URL}${IMAGE_FILE}"

        if [ $? -eq 0 ]; then
          echo "✅ 镜像已成功上传至 WebDAV：${WEBDAV_URL}${IMAGE_FILE}"
        else
          echo "❌ 上传到 WebDAV 失败"
          exit 1
        fi
