    - name: 5. 构建纯净 Ubuntu 根文件系统 (基于官方Base)
      run: |
        set -e
        echo "=== 开始从零构建纯净 Ubuntu 系统 ==="
        
        # 5.1 创建临时工作目录
        ROOTFS_DIR=$(pwd)/pure_rootfs_build
        sudo rm -rf $ROOTFS_DIR
        mkdir -p $ROOTFS_DIR
        
        # 5.2 下载并解压最干净的 Ubuntu Base 20.04
        echo "下载官方 ubuntu-base..."
        wget -c https://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.5-base-armhf.tar.gz
        sudo tar -xpf ubuntu-base-20.04.5-base-armhf.tar.gz -C $ROOTFS_DIR
        
        # 5.3 准备 chroot 环境
        echo "准备 Chroot 环境..."
        sudo cp /usr/bin/qemu-arm-static $ROOTFS_DIR/usr/bin/
        sudo cp -L /etc/resolv.conf $ROOTFS_DIR/etc/
        
        # 挂载虚拟文件系统
        sudo mount -t proc /proc $ROOTFS_DIR/proc
        sudo mount -t sysfs /sys $ROOTFS_DIR/sys
        sudo mount -o bind /dev $ROOTFS_DIR/dev
        sudo mount -o bind /dev/pts $ROOTFS_DIR/dev/pts

        # 5.4 在 Chroot 中配置纯净系统
        echo "正在 Chroot 环境中安装和配置系统..."
        sudo chroot "$ROOTFS_DIR" /bin/bash << 'CHROOT_EOF'
#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive
export LC_ALL=C

echo "----- 第1步: 配置环境与软件源 -----"
# 关键修复：挂载tmpfs解决空间不足
mount -t tmpfs tmpfs /tmp
mount -t tmpfs tmpfs /var/cache/apt/archives

# 使用华为云镜像源（国内稳定）
cat > /etc/apt/sources.list << 'SOURCES_EOF'
deb http://repo.huaweicloud.com/ubuntu-ports/ focal main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-updates main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-security main restricted universe multiverse
deb http://repo.huaweicloud.com/ubuntu-ports/ focal-backports main restricted universe multiverse
SOURCES_EOF

echo "----- 第2步: 更新系统并安装核心软件 -----"
apt-get update

# 分阶段安装，确保基础优先
apt-get install -y systemd systemd-sysv dbus
apt-get install -y ifupdown net-tools iproute2 iputils-ping
apt-get install -y openssh-server ssh sudo
apt-get install -y vim-tiny less lsof htop wget curl
apt-get install -y cron rsyslog logrotate bash-completion
apt-get install -y network-manager ethtool

echo "----- 第3步: 基础系统配置 -----"
# 主机名与网络
echo "hi3798mv100" > /etc/hostname
cat > /etc/hosts << 'HOSTS_EOF'
127.0.0.1   localhost
127.0.1.1   hi3798mv100
::1         ip6-localhost ip6-loopback
fe00::0     ip6-localnet
ff00::0     ip6-mcastprefix
ff02::1     ip6-allnodes
ff02::2     ip6-allrouters
HOSTS_EOF

# 时区
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# Root 密码
echo "root:root123" | chpasswd

# SSH 配置（允许Root登录）
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 网络配置 (DHCP)
mkdir -p /etc/network/interfaces.d
cat > /etc/network/interfaces.d/eth0 << 'NET_EOF'
auto eth0
iface eth0 inet dhcp
NET_EOF

echo "----- 第4步: 深度清理 -----"
apt-get autoremove -y --purge
apt-get clean
rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 移除构建用的模拟器
rm -f /usr/bin/qemu-arm-static

echo "----- ✅ 纯净 Ubuntu 系统配置完成 -----"
CHROOT_EOF

        # 5.5 卸载虚拟文件系统
        sudo umount -lf $ROOTFS_DIR/dev/pts 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/dev 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/sys 2>/dev/null || true
        sudo umount -lf $ROOTFS_DIR/proc 2>/dev/null || true
        
        echo "=== 纯净根文件系统构建完成 ==="
